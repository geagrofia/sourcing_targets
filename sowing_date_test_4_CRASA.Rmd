---
title: "Mapping Sowing Date for Nigeria"
author: "A Farrow"
date: "`r Sys.Date()`"
output:
  html_document:  
    code_folding: "hide"
    theme: united
    number_sections: no
    toc: yes
    toc_float: true
    toc_depth: 2
---

```{r setup, include = FALSE}

library(fuZR)
library(knitr)
library(irm)
library(tibble)
library(tidyverse)
library(sf)
library(terra)
library(lubridate)
library(kableExtra)

knitr::opts_chunk$set(echo = TRUE)

```

# Create a test dataset

In this section I create a dataset of 100 observations to test the dynamic sowing date method.

The dataset has a sowing date set between 162 and 180 days, with the earliest sowing date in the south-west corner and the latest in the north-east.

I add monthly precipitation set randomly for each observation between normal monthly rainfall totals for Ethiopia. I add small adjustments to the precipitation in June, July, September and October based on latitude and longitude.

I also add monthly mean temperatures set randomly for each observation between normal monthly temperature ranges for Ethiopia.

Coordinates in latitude and longitude are added with an observation at whole degree longitude/latitude confluence locations, in a square pattern from (1, 1) to (10, 10).

A raster mask is created for later use in creating the separate monthly precipitation raster layers.


```{r data}


prec01 <- runif(100, 0, 5)
prec02 <- runif(100, 0, 10)
prec03 <- runif(100, 0, 20)
prec04 <- runif(100, 10, 30)
prec05 <- runif(100, 10, 30)
prec06 <- runif(100, 60, 80)
prec07 <- runif(100, 60, 100)
prec08 <- runif(100, 70, 110)
prec09 <- runif(100, 70, 90)
prec10 <- runif(100, 40, 60)
prec11 <- runif(100, 10, 20)
prec12 <- runif(100, 0, 10)
tmean01 <- runif(100, 15, 20)
tmean02 <- runif(100, 16, 22)
tmean03 <- runif(100, 17, 25)
tmean04 <- runif(100, 18, 26)
tmean05 <- runif(100, 19, 27)
tmean06 <- runif(100, 19, 28)
tmean07 <- runif(100, 18, 28)
tmean08 <- runif(100, 18, 27)
tmean09 <- runif(100, 17, 24)
tmean10 <- runif(100, 17, 23)
tmean11 <- runif(100, 16, 22)
tmean12 <- runif(100, 16, 21)
long <- rep(c(1:10), 10)
lat <-
  c(
    rep(c(1), 10),
    rep(c(2), 10),
    rep(c(3), 10),
    rep(c(4), 10),
    rep(c(5), 10),
    rep(c(6), 10),
    rep(c(7), 10),
    rep(c(8), 10),
    rep(c(9), 10),
    rep(c(10), 10)
  )
#sow_date <- floor(runif(100, 160, 180))


sow_date_dat <-
  tibble(
#    sow_date,
    prec01,
    prec02,
    prec03,
    prec04,
    prec05,
    prec06,
    prec07,
    prec08,
    prec09,
    prec10,
    prec11,
    prec12,
    tmean01,
    tmean02,
    tmean03,
    tmean04,
    tmean05,
    tmean06,
    tmean07,
    tmean08,
    tmean09,
    tmean10,
    tmean11,
    tmean12,
    long,
    lat
  )

sow_date_dat$sow_date <- 160 + sow_date_dat$lat + sow_date_dat$long
sow_date_dat$prec06 <- sow_date_dat$prec06 - sow_date_dat$lat - sow_date_dat$long
sow_date_dat$prec07 <- sow_date_dat$prec07 - (sow_date_dat$lat / 2) - (sow_date_dat$long / 2)
sow_date_dat$prec09 <- sow_date_dat$prec09 + (sow_date_dat$lat / 2) + (sow_date_dat$long / 2)
sow_date_dat$prec10 <- sow_date_dat$prec10 +  sow_date_dat$lat + sow_date_dat$long



sow_date_sf <-
  st_as_sf(sow_date_dat,
           coords = c("long", "lat"),
           crs = 4236)

mask <- rast(
  nrows = 10,
  ncols = 10,
  xmin = 1,
  xmax = 10,
  ymin = 1,
  ymax = 10,
  vals = 1
)

plot(sow_date_sf, max.plot = 25)

```

# Phenology calculations

I modify the normal phenology calculatons.

I read a csv file with the lengths of phenological stages.

The csv file should only contain integer values for phenological stage lengths. This is so that the function for calculating the percentage of each calendar month in the period does not double-count those days that are in more than one phenological stage.

The start and end dates of each phenological stage are now made more explicit and there is now no overlap - again so that days are not double-counted.

The overall length of the growing period is maintained.

```{r phenology}

sowing_date_digalu_on <-
    read.csv(paste0("D:/repos/RCM/shiny_hide_sidebar/shiny_data/sowing_date_digalu_on_int.csv"))
  
sow_date_dat$est_e <- sow_date_dat$sow_date + sowing_date_digalu_on$est_length[1]
sow_date_dat$veg_s <- sow_date_dat$est_e + 1
sow_date_dat$veg_e <- sow_date_dat$veg_s + sowing_date_digalu_on$veg_length[1] - 1
sow_date_dat$flw_s <- sow_date_dat$veg_e + 1
sow_date_dat$flw_e <- sow_date_dat$flw_s + sowing_date_digalu_on$flw_length[1] - 1
sow_date_dat$yld_s <- sow_date_dat$flw_e + 1 
sow_date_dat$yld_e <- sow_date_dat$yld_s + sowing_date_digalu_on$yld_length[1] - 1
sow_date_dat$rip_s <- sow_date_dat$yld_e + 1 
sow_date_dat$rip_e <- sow_date_dat$rip_s + sowing_date_digalu_on$rip_length[1] - 1

sowing_date_digalu_on

```

# Rasterize the precipitation data

The data tibble is used to create a simple features point dataset.

The precipitation from the sf dataset is converted to a raster for each month, using the raster mask as a template.

Each layer is joined in a raster brick which is displayed.

```{r rasterize_prec}

sow_date_sf <-
  st_as_sf(sow_date_dat,
           coords = c("long", "lat"),
           crs = 4236)


prec01_r <- rasterize(sow_date_sf, mask, field = "prec01")
prec02_r <- rasterize(sow_date_sf, mask, field = "prec02")
prec03_r <- rasterize(sow_date_sf, mask, field = "prec03")
prec04_r <- rasterize(sow_date_sf, mask, field = "prec04")
prec05_r <- rasterize(sow_date_sf, mask, field = "prec05")
prec06_r <- rasterize(sow_date_sf, mask, field = "prec06")
prec07_r <- rasterize(sow_date_sf, mask, field = "prec07")
prec08_r <- rasterize(sow_date_sf, mask, field = "prec08")
prec09_r <- rasterize(sow_date_sf, mask, field = "prec09")
prec10_r <- rasterize(sow_date_sf, mask, field = "prec10")
prec11_r <- rasterize(sow_date_sf, mask, field = "prec11")
prec12_r <- rasterize(sow_date_sf, mask, field = "prec12")
prec_r <- rast(list(prec01_r, prec02_r, prec03_r, prec04_r, prec05_r, prec06_r, prec07_r, prec08_r, prec09_r, prec10_r, prec11_r, prec12_r))

plot(prec_r, main = "monthly precipitation (mm)")
            
```

# Rasterize the temperature data

The tibble is used to create a simple features point dataset.

The temperature from the sf dataset is converted to a raster for each month, using the raster mask as a template.

Each layer is joined in a raster brick which is displayed.

```{r rasterize_tmean}

tmean01_r <- rasterize(sow_date_sf, mask, field = "tmean01")
tmean02_r <- rasterize(sow_date_sf, mask, field = "tmean02")
tmean03_r <- rasterize(sow_date_sf, mask, field = "tmean03")
tmean04_r <- rasterize(sow_date_sf, mask, field = "tmean04")
tmean05_r <- rasterize(sow_date_sf, mask, field = "tmean05")
tmean06_r <- rasterize(sow_date_sf, mask, field = "tmean06")
tmean07_r <- rasterize(sow_date_sf, mask, field = "tmean07")
tmean08_r <- rasterize(sow_date_sf, mask, field = "tmean08")
tmean09_r <- rasterize(sow_date_sf, mask, field = "tmean09")
tmean10_r <- rasterize(sow_date_sf, mask, field = "tmean10")
tmean11_r <- rasterize(sow_date_sf, mask, field = "tmean11")
tmean12_r <- rasterize(sow_date_sf, mask, field = "tmean12")
tmean_r <- rast(list(tmean01_r, tmean02_r, tmean03_r, tmean04_r, tmean05_r, tmean06_r, tmean07_r, tmean08_r, tmean09_r, tmean10_r, tmean11_r, tmean12_r))

plot(tmean_r, main = "monthly tmean (degC)")
            
```

# Mask for phenological periods

The maps below give the distribution of each phenological stage over the months.

I use the same function as Walvoort (here called easyfun, but called .growth_period in irm package), and apply this on a cell-by-cell basis using the start and end days for each cell.

When the function is applied to the tibble using 'apply' it produces a 100 *x* 12 matrix. I transpose this matrix, append it to the original tibble and create a temporary data frame. I convert this to a sf object and create rasters for each month *x* growing period combination. I join the individual rasters in a raster brick for each growing period - to be used later.

I also run a portion of the function to check on which days are used to define the phenological stages.


<div class="fold o">   
```{r requirements phen stages02, cache = FALSE, fig.width=8, fig.height=7, out.width=700}

easyfun <- function(x, start_day, end_day) {
  
  days <- 1:365
    months <- days %>% as.character %>% as.Date("%j") %>% 
        format("%m") %>% as.integer
    days <- round(x[start_day]):round(x[end_day])
    tabulate(bin = months[days], nbins = 12L)/tabulate(bin = months, 
        nbins = 12L)

}

daystest <- function(x, start_day, end_day) {
  
  c(round(x[start_day]),round(x[end_day]))
}


#test the days to include
grow_p_matrix_days <- t(apply(sow_date_dat, 1, daystest, start_day = "sow_date", end_day = "rip_e" ))
grow_e_matrix_days <- t(apply(sow_date_dat, 1, daystest, start_day = "sow_date", end_day = "est_e" ))
grow_v_matrix_days <- t(apply(sow_date_dat, 1, daystest, start_day = "veg_s", end_day = "veg_e" ))
grow_f_matrix_days <- t(apply(sow_date_dat, 1, daystest, start_day = "flw_s", end_day = "flw_e" ))
grow_y_matrix_days <- t(apply(sow_date_dat, 1, daystest, start_day = "yld_s", end_day = "yld_e" ))
grow_r_matrix_days <- t(apply(sow_date_dat, 1, daystest, start_day = "rip_s", end_day = "rip_e" ))

# growing period

#get a matrix of values showing the proportion of each month in the growng period for each cell
grow_p_matrix <- t(apply(sow_date_dat, 1, easyfun, start_day = "sow_date", end_day = "rip_e" ))


#join the matrix to the existing data frame
sow_date_dat2 <- data.frame(sow_date_dat, grow_p_matrix)

#convert first to sf object
sow_date_sf2 <-
  st_as_sf(sow_date_dat2,
           coords = c("long", "lat"),
           crs = 4236)

#create monthly raster rasks for the growing period
prec01_gp_r <- rasterize(sow_date_sf2, mask, field = "X1")
prec02_gp_r <- rasterize(sow_date_sf2, mask, field = "X2")
prec03_gp_r <- rasterize(sow_date_sf2, mask, field = "X3")
prec04_gp_r <- rasterize(sow_date_sf2, mask, field = "X4")
prec05_gp_r <- rasterize(sow_date_sf2, mask, field = "X5")
prec06_gp_r <- rasterize(sow_date_sf2, mask, field = "X6")
prec07_gp_r <- rasterize(sow_date_sf2, mask, field = "X7")
prec08_gp_r <- rasterize(sow_date_sf2, mask, field = "X8")
prec09_gp_r <- rasterize(sow_date_sf2, mask, field = "X9")
prec10_gp_r <- rasterize(sow_date_sf2, mask, field = "X10")
prec11_gp_r <- rasterize(sow_date_sf2, mask, field = "X11")
prec12_gp_r <- rasterize(sow_date_sf2, mask, field = "X12")
prec_gp_r <- rast(list(prec01_gp_r, prec02_gp_r, prec03_gp_r, prec04_gp_r, prec05_gp_r, prec06_gp_r, prec07_gp_r, prec08_gp_r, prec09_gp_r, prec10_gp_r, prec11_gp_r, prec12_gp_r))

plot(prec_gp_r, main = "growing period")


# establishment period

#get a matrix of values showing the proportion of each month in the establishment period for each cell
grow_e_matrix <- t(apply(sow_date_dat, 1, easyfun, start_day = "sow_date" , end_day = "est_e" ))

#join the matrix to the existing data frame
sow_date_dat2 <- data.frame(sow_date_dat, grow_e_matrix)

#convert first to sf object
sow_date_sf2 <-
  st_as_sf(sow_date_dat2,
           coords = c("long", "lat"),
           crs = 4236)

#create monthly raster rasks for the establishment period
prec01_ep_r <- rasterize(sow_date_sf2, mask, field = "X1")
prec02_ep_r <- rasterize(sow_date_sf2, mask, field = "X2")
prec03_ep_r <- rasterize(sow_date_sf2, mask, field = "X3")
prec04_ep_r <- rasterize(sow_date_sf2, mask, field = "X4")
prec05_ep_r <- rasterize(sow_date_sf2, mask, field = "X5")
prec06_ep_r <- rasterize(sow_date_sf2, mask, field = "X6")
prec07_ep_r <- rasterize(sow_date_sf2, mask, field = "X7")
prec08_ep_r <- rasterize(sow_date_sf2, mask, field = "X8")
prec09_ep_r <- rasterize(sow_date_sf2, mask, field = "X9")
prec10_ep_r <- rasterize(sow_date_sf2, mask, field = "X10")
prec11_ep_r <- rasterize(sow_date_sf2, mask, field = "X11")
prec12_ep_r <- rasterize(sow_date_sf2, mask, field = "X12")
prec_ep_r <- rast(list(prec01_ep_r, prec02_ep_r, prec03_ep_r, prec04_ep_r, prec05_ep_r, prec06_ep_r, prec07_ep_r, prec08_ep_r, prec09_ep_r, prec10_ep_r, prec11_ep_r, prec12_ep_r))

plot(prec_ep_r, main = "establishment period")

  
# vegetative period

#get a matrix of values showing the proportion of each month in the vegetative period for each cell
grow_v_matrix <- t(apply(sow_date_dat, 1, easyfun, start_day = "veg_s", end_day = "veg_e" ))

#join the matrix to the existing data frame
sow_date_dat2 <- data.frame(sow_date_dat, grow_v_matrix)

#convert first to sf object
sow_date_sf2 <-
  st_as_sf(sow_date_dat2,
           coords = c("long", "lat"),
           crs = 4236)

#create monthly raster rasks for the vegetative period
prec01_vp_r <- rasterize(sow_date_sf2, mask, field = "X1")
prec02_vp_r <- rasterize(sow_date_sf2, mask, field = "X2")
prec03_vp_r <- rasterize(sow_date_sf2, mask, field = "X3")
prec04_vp_r <- rasterize(sow_date_sf2, mask, field = "X4")
prec05_vp_r <- rasterize(sow_date_sf2, mask, field = "X5")
prec06_vp_r <- rasterize(sow_date_sf2, mask, field = "X6")
prec07_vp_r <- rasterize(sow_date_sf2, mask, field = "X7")
prec08_vp_r <- rasterize(sow_date_sf2, mask, field = "X8")
prec09_vp_r <- rasterize(sow_date_sf2, mask, field = "X9")
prec10_vp_r <- rasterize(sow_date_sf2, mask, field = "X10")
prec11_vp_r <- rasterize(sow_date_sf2, mask, field = "X11")
prec12_vp_r <- rasterize(sow_date_sf2, mask, field = "X12")
prec_vp_r <- rast(list(prec01_vp_r, prec02_vp_r, prec03_vp_r, prec04_vp_r, prec05_vp_r, prec06_vp_r, prec07_vp_r, prec08_vp_r, prec09_vp_r, prec10_vp_r, prec11_vp_r, prec12_vp_r))

plot(prec_vp_r, main = "vegetative period")


# flowering period

#get a matrix of values showing the proportion of each month in the flowering period for each cell
grow_f_matrix <- t(apply(sow_date_dat, 1, easyfun, start_day = "flw_s", end_day = "flw_e" ))

#join the matrix to the existing data frame
sow_date_dat2 <- data.frame(sow_date_dat, grow_f_matrix)

#convert first to sf object
sow_date_sf2 <-
  st_as_sf(sow_date_dat2,
           coords = c("long", "lat"),
           crs = 4236)

#create monthly raster rasks for the flowering period
prec01_fp_r <- rasterize(sow_date_sf2, mask, field = "X1")
prec02_fp_r <- rasterize(sow_date_sf2, mask, field = "X2")
prec03_fp_r <- rasterize(sow_date_sf2, mask, field = "X3")
prec04_fp_r <- rasterize(sow_date_sf2, mask, field = "X4")
prec05_fp_r <- rasterize(sow_date_sf2, mask, field = "X5")
prec06_fp_r <- rasterize(sow_date_sf2, mask, field = "X6")
prec07_fp_r <- rasterize(sow_date_sf2, mask, field = "X7")
prec08_fp_r <- rasterize(sow_date_sf2, mask, field = "X8")
prec09_fp_r <- rasterize(sow_date_sf2, mask, field = "X9")
prec10_fp_r <- rasterize(sow_date_sf2, mask, field = "X10")
prec11_fp_r <- rasterize(sow_date_sf2, mask, field = "X11")
prec12_fp_r <- rasterize(sow_date_sf2, mask, field = "X12")
prec_fp_r <- rast(list(prec01_fp_r, prec02_fp_r, prec03_fp_r, prec04_fp_r, prec05_fp_r, prec06_fp_r, prec07_fp_r, prec08_fp_r, prec09_fp_r, prec10_fp_r, prec11_fp_r, prec12_fp_r))

plot(prec_fp_r, main = "flowering period")

# yield formation period

#get a matrix of values showing the proportion of each month in the yield formation period for each cell
grow_y_matrix <- t(apply(sow_date_dat, 1, easyfun, start_day = "yld_s", end_day = "yld_e" ))

#join the matrix to the existing data frame
sow_date_dat2 <- data.frame(sow_date_dat, grow_y_matrix)

#convert first to sf object
sow_date_sf2 <-
  st_as_sf(sow_date_dat2,
           coords = c("long", "lat"),
           crs = 4236)

#create monthly raster rasks for the yield formation period
prec01_yp_r <- rasterize(sow_date_sf2, mask, field = "X1")
prec02_yp_r <- rasterize(sow_date_sf2, mask, field = "X2")
prec03_yp_r <- rasterize(sow_date_sf2, mask, field = "X3")
prec04_yp_r <- rasterize(sow_date_sf2, mask, field = "X4")
prec05_yp_r <- rasterize(sow_date_sf2, mask, field = "X5")
prec06_yp_r <- rasterize(sow_date_sf2, mask, field = "X6")
prec07_yp_r <- rasterize(sow_date_sf2, mask, field = "X7")
prec08_yp_r <- rasterize(sow_date_sf2, mask, field = "X8")
prec09_yp_r <- rasterize(sow_date_sf2, mask, field = "X9")
prec10_yp_r <- rasterize(sow_date_sf2, mask, field = "X10")
prec11_yp_r <- rasterize(sow_date_sf2, mask, field = "X11")
prec12_yp_r <- rasterize(sow_date_sf2, mask, field = "X12")
prec_yp_r <- rast(list(prec01_yp_r, prec02_yp_r, prec03_yp_r, prec04_yp_r, prec05_yp_r, prec06_yp_r, prec07_yp_r, prec08_yp_r, prec09_yp_r, prec10_yp_r, prec11_yp_r, prec12_yp_r))

plot(prec_yp_r, main = "yield formation period")


# ripening period

#get a matrix of values showing the proportion of each month in the ripening period for each cell
grow_r_matrix <- t(apply(sow_date_dat, 1, easyfun, start_day = "rip_s", end_day = "rip_e" ))

#join the matrix to the existing data frame
sow_date_dat2 <- data.frame(sow_date_dat, grow_r_matrix)

#convert first to sf object
sow_date_sf2 <-
  st_as_sf(sow_date_dat2,
           coords = c("long", "lat"),
           crs = 4236)

#create monthly raster rasks for the ripening period
prec01_rp_r <- rasterize(sow_date_sf2, mask, field = "X1")
prec02_rp_r <- rasterize(sow_date_sf2, mask, field = "X2")
prec03_rp_r <- rasterize(sow_date_sf2, mask, field = "X3")
prec04_rp_r <- rasterize(sow_date_sf2, mask, field = "X4")
prec05_rp_r <- rasterize(sow_date_sf2, mask, field = "X5")
prec06_rp_r <- rasterize(sow_date_sf2, mask, field = "X6")
prec07_rp_r <- rasterize(sow_date_sf2, mask, field = "X7")
prec08_rp_r <- rasterize(sow_date_sf2, mask, field = "X8")
prec09_rp_r <- rasterize(sow_date_sf2, mask, field = "X9")
prec10_rp_r <- rasterize(sow_date_sf2, mask, field = "X10")
prec11_rp_r <- rasterize(sow_date_sf2, mask, field = "X11")
prec12_rp_r <- rasterize(sow_date_sf2, mask, field = "X12")
prec_rp_r <- rast(list(prec01_rp_r, prec02_rp_r, prec03_rp_r, prec04_rp_r, prec05_rp_r, prec06_rp_r, prec07_rp_r, prec08_rp_r, prec09_rp_r, prec10_rp_r, prec11_rp_r, prec12_rp_r))

plot(prec_rp_r, main = "ripening period")

``` 


# Precipitation calculation

By combining precipitation in each month and the phenological stages above, we can derive the precipitation for each phenological stage.

The crop requirements for wheat in Sys et al. (1993, p 177), specify the **monthly** precipitation for those periods, not the actual precipitation. This requires that the precipitation in these periods are adjusted for a whole month. Therefore the sum of the monthly precipitation for the five growth stages will be greater than the overall growing period.

 
```{r requirements prec01, cache = FALSE, fig.width=8, fig.height=7, out.width=450, fig.show="hold"}

# get centroid coordinates
x <-  pull(sow_date_dat, long)
y <-  pull(sow_date_dat, lat)
xy <- cbind(x, y)

# precipitation of growing period
r_prec_g <- sum(prec_r * prec_gp_r)

r_prec_g %>%  plot(main = "precipitation growing period (mm)")
sow_date_dat$P_g = r_prec_g %>% raster::extract(xy)

# monthly rainfall establishment period
r_prec_e <- sum(prec_r * prec_ep_r) / sum(prec_ep_r)

r_prec_e %>%  plot(main = "precipitation est period (mm)")
sow_date_dat$P_e = r_prec_e %>% raster::extract(xy)

# monthly rainfall vegetative period
r_prec_v <- sum(prec_r * prec_vp_r) / sum(prec_vp_r)

r_prec_v %>%  plot(main = "precipitation veg period (mm)")
sow_date_dat$P_v = r_prec_v %>% raster::extract(xy)

# monthly rainfall flowering period
r_prec_f <- sum(prec_r * prec_fp_r) / sum(prec_fp_r)

r_prec_f %>%  plot(main = "precipitation flowering period (mm)")
sow_date_dat$P_f = r_prec_f %>% raster::extract(xy)

# monthly yield formation period
r_prec_y <- sum(prec_r * prec_yp_r) / sum(prec_yp_r)

r_prec_y %>%  plot(main = "precipitation yield formation period (mm)")
sow_date_dat$P_y = r_prec_y %>% raster::extract(xy)

# monthly rainfall ripening period
r_prec_r <- sum(prec_r * prec_rp_r) / sum(prec_rp_r)

r_prec_r %>%  plot(main = "precipitation ripening period (mm)")
sow_date_dat$P_r = r_prec_r %>% raster::extract(xy)

``` 

# Temperature calculation

By combining temperature in each month and the phenological stages above, we can derive the mean temperature for each phenological stage.


```{r requirements temp01, cache = FALSE, fig.width=8, fig.height=7, out.width=450, fig.show="hold"}

# precipitation of growing period
r_tmean_g <- sum(tmean_r * prec_gp_r) / sum(prec_gp_r)

r_tmean_g %>%  plot(main = "tmean growing period (degC)")
sow_date_dat$T_g = r_tmean_g %>% raster::extract(xy)

# monthly rainfall establishment period
r_tmean_e <- sum(tmean_r * prec_ep_r) / sum(prec_ep_r)

r_tmean_e %>%  plot(main = "tmean est period (degC)")
sow_date_dat$T_e = r_tmean_e %>% raster::extract(xy)

# monthly rainfall vegetative period
r_tmean_v <- sum(tmean_r * prec_vp_r) / sum(prec_vp_r)

r_tmean_v %>%  plot(main = "tmean veg period (degC)")
sow_date_dat$T_v = r_tmean_v %>% raster::extract(xy)

# monthly rainfall flowering period
r_tmean_f <- sum(tmean_r * prec_fp_r) / sum(prec_fp_r)

r_tmean_f %>%  plot(main = "tmean flowering period (degC)")
sow_date_dat$T_f = r_tmean_f %>% raster::extract(xy)

# monthly yield formation period
r_tmean_y <- sum(tmean_r * prec_yp_r) / sum(prec_yp_r)

r_tmean_y %>%  plot(main = "tmean yield formation period (degC)")
sow_date_dat$T_y = r_tmean_y %>% raster::extract(xy)

# monthly rainfall ripening period
r_tmean_r <- sum(tmean_r * prec_rp_r) / sum(prec_rp_r)

r_tmean_r %>%  plot(main = "tmean ripening period (degC)")
sow_date_dat$P_r = r_tmean_r %>% raster::extract(xy)

``` 

# Create a dataset for Nigeria

In this section I create a dataset based on the historical season onset for Nigeria to apply the dynamic sowing date method.

The season onset has a width of 179 pixels and a height of 170 pixels, but this includes Sierra Leone and Burundi so needs to be cropped to Nigeria.

The cropped dataset has a sowing date set between 112 and 180 days, with the earliest sowing date in the south-west corner and the latest in the north-east.

I add dekadal precipitation for each observation for Nigeria.

A raster mask is created for later use in creating the separate dekadal precipitation raster layers.


```{r data_Nigeria}

# the season onset will be resampled to the higher resolution precipitation

# get precipitation for Nigeria
r_prec <-rast("D:/repos/sourcing_targets/data/input/chirps_all.tif")

# do a rough crop to boundaries of Nigeria
r_prec_nig <- crop(r_prec, ext(2.55, 15.55, 3.80, 14.80))

# reclassify to remove NA values (NAflag doesn't work because there are multiple NA values)
m <- c(-9999,-1, NA)
rclmat <- matrix(m, ncol=3, byrow=TRUE)
r_prec_nig_NA <- classify(r_prec_nig, rclmat, include.lowest=TRUE)
r_prec_nig_NA

# get onset for nigeria
r_hist_sorghum___onset <-rast("D:/repos/sourcing_targets/data/NGA/sorghum/hist_sorghum___onset.tif")
r_hist_sorghum___onset
plot(r_hist_sorghum___onset)

# do a rough crop to boundaries of Nigeria
r_nig_hist_sorghum___onset <- crop(r_hist_sorghum___onset, ext(2.55, 15.55, 3.80, 14.80))
r_nig_hist_sorghum___onset
plot(r_nig_hist_sorghum___onset)

r_nig_hist_sorghum___onset_rsmp <- resample(r_nig_hist_sorghum___onset, r_prec_nig,  method="near")
r_nig_hist_sorghum___onset_rsmp
plot(r_nig_hist_sorghum___onset_rsmp)

# convert to df
nig_sow_date_df <- as.data.frame(r_nig_hist_sorghum___onset_rsmp, xy=TRUE, cells=TRUE, na.rm=NA)
nig_prec_df <- as.data.frame(r_prec_nig, xy=TRUE, cells=TRUE, na.rm=NA)

nig_all_df <- inner_join(nig_sow_date_df, nig_prec_df, by=c("cell"))

```

# Phenology calculations for Nigeria

I modify the normal phenology calculatons.

I read a csv file with the lengths of phenological stages.

The csv file should only contain integer values for phenological stage lengths. This is so that the function for calculating the percentage of each calendar month in the period does not double-count those days that are in more than one phenological stage.

The start and end dates of each phenological stage are now made more explicit and there is now no overlap - again so that days are not double-counted.

The overall length of the growing period is maintained.

```{r phenology_Nigeria}

growth_stages <-
    read.csv(paste0("D:/repos/sourcing_targets/data/NGA/sorghum/sowing_date_sorghum_int.csv"))

nig_all_df$est_e <- nig_all_df$hist_sorghum___onset + growth_stages$est_length[1]
nig_all_df$veg_s <- nig_all_df$est_e + 1
nig_all_df$veg_e <- nig_all_df$veg_s + growth_stages$veg_length[1] - 1
nig_all_df$flw_s <- nig_all_df$veg_e + 1
nig_all_df$flw_e <- nig_all_df$flw_s + growth_stages$flw_length[1] - 1
nig_all_df$yld_s <- nig_all_df$flw_e + 1 
nig_all_df$yld_e <- nig_all_df$yld_s + growth_stages$yld_length[1] - 1
nig_all_df$rip_s <- nig_all_df$yld_e + 1 
nig_all_df$rip_e <- nig_all_df$rip_s + growth_stages$rip_length[1] - 1

growth_stages %>%
    kable(digits = 3, caption = "Growth Stage Lengths") %>% kable_styling("striped", full_width = T) %>% print

num_years <- max(ceiling(nig_all_df$rip_e / 365))
cat(paste("Growth Stages span", num_years, "calendar years"))

```


# Mask for phenological periods for Nigeria

The maps below give the distribution of each phenological stage over the months.

I use the same function as Walvoort (here called easyfun, but called .growth_period_dekad in CRASA), and apply this on a cell-by-cell basis using the start and end days for each cell.

When the function is applied to the tibble using 'apply' it produces a 342 *x* 36 matrix. I transpose this matrix, append it to the original tibble and create a temporary data frame. I convert this to a sf object and create rasters for each month *x* growing period combination. I join the individual rasters in a SpatRaster brick for each growing period - to be used later.

I also run a portion of the function to check on which days are used to define the phenological stages.


<div class="fold o">   
```{r phen_stages_functions_Nigeria, cache = FALSE, fig.width=8, fig.height=7, out.width=700}


dekad <- function(x, type = c("month", "year"), ...) {
  type <- match.arg(type)
  x <- as.Date(x, ...)
  res <- ifelse(day(x) > 20,  3, ifelse(day(x) > 10, 2, 1))
  if(type == "year") res <- month(x)*3 + res - 3
  return(res)
}

growth_period_long_dekad_tbl <- function (x, day_begin, day_end, num_years) 
{
  days <- 1:365
  day_dekads <- days %>% as.character %>% as.Date("%j") %>% 
    dekad(type = "year") %>% as.integer 
  dekads <- rep.int(day_dekads, num_years)
  days <- round(x[day_begin]):round(x[day_end])
  tabulate(bin = dekads[days], nbins = 36L)* num_years/tabulate(bin = dekads, 
                                                                nbins = 36L)
}

growth_period_long_tbl <- function(x, day_begin, day_end, num_years) {
  
  days <- 1:365
    months <- days %>% as.character %>% as.Date("%j") %>% 
        format("%m") %>% as.integer
    days <- round(x[day_begin]):round(x[day_end])
    tabulate(bin = months[days], nbins = 12L)* num_years/tabulate(bin = months, 
        nbins = 12L)

}


daystest <- function(x, start_day, end_day) {
  
  c(round(x[start_day]),round(x[end_day]))
}


#test the days to include
grow_p_matrix_days <- t(apply(nig_all_df, 1, daystest, start_day = "hist_sorghum___onset", end_day = "rip_e" ))
grow_e_matrix_days <- t(apply(nig_all_df , 1, daystest, start_day = "hist_sorghum___onset", end_day = "est_e" ))
grow_v_matrix_days <- t(apply(nig_all_df, 1, daystest, start_day = "veg_s", end_day = "veg_e" ))
grow_f_matrix_days <- t(apply(nig_all_df, 1, daystest, start_day = "flw_s", end_day = "flw_e" ))
grow_y_matrix_days <- t(apply(nig_all_df, 1, daystest, start_day = "yld_s", end_day = "yld_e" ))
grow_r_matrix_days <- t(apply(nig_all_df, 1, daystest, start_day = "rip_s", end_day = "rip_e" ))
```

## Growing Period - monthly  distribution

```{r phen_stages_gp_mth_Nigeria, cache = FALSE, fig.width=8, fig.height=7, out.width=700}

#get a matrix of values showing the proportion of each month in the growing period for each cell
grow_p_matrix_m <- t(apply(nig_all_df, 1, growth_period_long_tbl, day_begin = "hist_sorghum___onset", day_end = "rip_e", num_years = num_years ))

#join the matrix to the existing data frame
nig_all_df_mth_gp <- data.frame(nig_all_df, grow_p_matrix_m)

#convert first to sf object
nig_all_sf_mth_gp <-
  st_as_sf(nig_all_df_mth_gp,
           coords = c("x.x", "y.x"),
           crs = 4236)

#create monthly raster masks for the growing period
mth_01_gp_r <- rasterize(nig_all_sf_mth_gp, r_prec_nig_NA, field = "X1")
mth_02_gp_r <- rasterize(nig_all_sf_mth_gp, r_prec_nig_NA, field = "X2")
mth_03_gp_r <- rasterize(nig_all_sf_mth_gp, r_prec_nig_NA, field = "X3")
mth_04_gp_r <- rasterize(nig_all_sf_mth_gp, r_prec_nig_NA, field = "X4")
mth_05_gp_r <- rasterize(nig_all_sf_mth_gp, r_prec_nig_NA, field = "X5")
mth_06_gp_r <- rasterize(nig_all_sf_mth_gp, r_prec_nig_NA, field = "X6")
mth_07_gp_r <- rasterize(nig_all_sf_mth_gp, r_prec_nig_NA, field = "X7")
mth_08_gp_r <- rasterize(nig_all_sf_mth_gp, r_prec_nig_NA, field = "X8")
mth_09_gp_r <- rasterize(nig_all_sf_mth_gp, r_prec_nig_NA, field = "X9")
mth_10_gp_r <- rasterize(nig_all_sf_mth_gp, r_prec_nig_NA, field = "X10")
mth_11_gp_r <- rasterize(nig_all_sf_mth_gp, r_prec_nig_NA, field = "X11")
mth_12_gp_r <- rasterize(nig_all_sf_mth_gp, r_prec_nig_NA, field = "X12")

mth_gp_r <-
  rast(
    list(
      mth_01_gp_r,
      mth_02_gp_r,
      mth_03_gp_r,
      mth_04_gp_r,
      mth_05_gp_r,
      mth_06_gp_r,
      mth_07_gp_r,
      mth_08_gp_r,
      mth_09_gp_r,
      mth_10_gp_r,
      mth_11_gp_r,
      mth_12_gp_r
    )
  )

plot(mth_gp_r, main = "growing period", maxnl = 12)

writeRaster(mth_gp_r, 
    "D:/repos/sourcing_targets/data/NGA/sorghum/mth_gp_r.tif",
    overwrite = TRUE,
    filetype = "GTiff"
  )

```

## Growing Period - dekadal  distribution

```{r phen_stages_gp_dek_Nigeria, cache = FALSE, fig.width=8, fig.height=7, out.width=700}

#get a matrix of values showing the proportion of each dekad in the growing period for each cell

grow_p_matrix_d <- t(apply(nig_all_df, 1, growth_period_long_dekad_tbl, day_begin = "hist_sorghum___onset", day_end = "rip_e", num_years = num_years))

#join the matrix to the existing data frame
nig_all_df_dek_gp <- data.frame(nig_all_df, grow_p_matrix_d)

#convert first to sf object
nig_all_sf_dek_gp <-
  st_as_sf(nig_all_df_dek_gp,
           coords = c("x.x", "y.x"),
           crs = 4236)

#create dekadal raster masks for the growing period
dek_01_gp_r <- rasterize(nig_all_sf_dek_gp, r_prec_nig_NA, field = "X1")
dek_02_gp_r <- rasterize(nig_all_sf_dek_gp, r_prec_nig_NA, field = "X2")
dek_03_gp_r <- rasterize(nig_all_sf_dek_gp, r_prec_nig_NA, field = "X3")
dek_04_gp_r <- rasterize(nig_all_sf_dek_gp, r_prec_nig_NA, field = "X4")
dek_05_gp_r <- rasterize(nig_all_sf_dek_gp, r_prec_nig_NA, field = "X5")
dek_06_gp_r <- rasterize(nig_all_sf_dek_gp, r_prec_nig_NA, field = "X6")
dek_07_gp_r <- rasterize(nig_all_sf_dek_gp, r_prec_nig_NA, field = "X7")
dek_08_gp_r <- rasterize(nig_all_sf_dek_gp, r_prec_nig_NA, field = "X8")
dek_09_gp_r <- rasterize(nig_all_sf_dek_gp, r_prec_nig_NA, field = "X9")
dek_10_gp_r <- rasterize(nig_all_sf_dek_gp, r_prec_nig_NA, field = "X10")
dek_11_gp_r <- rasterize(nig_all_sf_dek_gp, r_prec_nig_NA, field = "X11")
dek_12_gp_r <- rasterize(nig_all_sf_dek_gp, r_prec_nig_NA, field = "X12")
dek_13_gp_r <- rasterize(nig_all_sf_dek_gp, r_prec_nig_NA, field = "X13")
dek_14_gp_r <- rasterize(nig_all_sf_dek_gp, r_prec_nig_NA, field = "X14")
dek_15_gp_r <- rasterize(nig_all_sf_dek_gp, r_prec_nig_NA, field = "X15")
dek_16_gp_r <- rasterize(nig_all_sf_dek_gp, r_prec_nig_NA, field = "X16")
dek_17_gp_r <- rasterize(nig_all_sf_dek_gp, r_prec_nig_NA, field = "X17")
dek_18_gp_r <- rasterize(nig_all_sf_dek_gp, r_prec_nig_NA, field = "X18")
dek_19_gp_r <- rasterize(nig_all_sf_dek_gp, r_prec_nig_NA, field = "X19")
dek_20_gp_r <- rasterize(nig_all_sf_dek_gp, r_prec_nig_NA, field = "X20")
dek_21_gp_r <- rasterize(nig_all_sf_dek_gp, r_prec_nig_NA, field = "X21")
dek_22_gp_r <- rasterize(nig_all_sf_dek_gp, r_prec_nig_NA, field = "X22")
dek_23_gp_r <- rasterize(nig_all_sf_dek_gp, r_prec_nig_NA, field = "X23")
dek_24_gp_r <- rasterize(nig_all_sf_dek_gp, r_prec_nig_NA, field = "X24")
dek_25_gp_r <- rasterize(nig_all_sf_dek_gp, r_prec_nig_NA, field = "X25")
dek_26_gp_r <- rasterize(nig_all_sf_dek_gp, r_prec_nig_NA, field = "X26")
dek_27_gp_r <- rasterize(nig_all_sf_dek_gp, r_prec_nig_NA, field = "X27")
dek_28_gp_r <- rasterize(nig_all_sf_dek_gp, r_prec_nig_NA, field = "X28")
dek_29_gp_r <- rasterize(nig_all_sf_dek_gp, r_prec_nig_NA, field = "X29")
dek_30_gp_r <- rasterize(nig_all_sf_dek_gp, r_prec_nig_NA, field = "X30")
dek_31_gp_r <- rasterize(nig_all_sf_dek_gp, r_prec_nig_NA, field = "X31")
dek_32_gp_r <- rasterize(nig_all_sf_dek_gp, r_prec_nig_NA, field = "X32")
dek_33_gp_r <- rasterize(nig_all_sf_dek_gp, r_prec_nig_NA, field = "X33")
dek_34_gp_r <- rasterize(nig_all_sf_dek_gp, r_prec_nig_NA, field = "X34")
dek_35_gp_r <- rasterize(nig_all_sf_dek_gp, r_prec_nig_NA, field = "X35")
dek_36_gp_r <- rasterize(nig_all_sf_dek_gp, r_prec_nig_NA, field = "X36")


dek_gp_r <-
  rast(
    list(
      dek_01_gp_r,
      dek_02_gp_r,
      dek_03_gp_r,
      dek_04_gp_r,
      dek_05_gp_r,
      dek_06_gp_r,
      dek_07_gp_r,
      dek_08_gp_r,
      dek_09_gp_r,
      dek_10_gp_r,
      dek_11_gp_r,
      dek_12_gp_r,
      dek_13_gp_r,
      dek_14_gp_r,
      dek_15_gp_r,
      dek_16_gp_r,
      dek_17_gp_r,
      dek_18_gp_r,
      dek_19_gp_r,
      dek_20_gp_r,
      dek_21_gp_r,
      dek_22_gp_r,
      dek_23_gp_r,
      dek_24_gp_r,
      dek_25_gp_r,
      dek_26_gp_r,
      dek_27_gp_r,
      dek_28_gp_r,
      dek_29_gp_r,
      dek_30_gp_r,
      dek_31_gp_r,
      dek_32_gp_r,
      dek_33_gp_r,
      dek_34_gp_r,
      dek_35_gp_r,
      dek_36_gp_r
    )
  )

plot(dek_gp_r, main = "growing period", maxnl = 36)

writeRaster(dek_gp_r, 
    "D:/repos/sourcing_targets/data/NGA/sorghum/dek_gp_r.tif",
    overwrite = TRUE,
    filetype = "GTiff"
  )

```


## Establishment stage - monthly  distribution

```{r phen_stages_est_mth_Nigeria, cache = FALSE, fig.width=8, fig.height=7, out.width=700}

#get a matrix of values showing the proportion of each month in the establishment stage for each cell
grow_e_matrix_m <- t(apply(nig_all_df, 1, growth_period_long_tbl, day_begin = "hist_sorghum___onset", day_end = "est_e", num_years = num_years ))

#join the matrix to the existing data frame
nig_all_df_mth_es <- data.frame(nig_all_df, grow_e_matrix_m)

#convert first to sf object
nig_all_sf_mth_es <-
  st_as_sf(nig_all_df_mth_es,
           coords = c("x.x", "y.x"),
           crs = 4236)

#create monthly raster masks for the establishment stage
mth_01_es_r <- rasterize(nig_all_sf_mth_es, r_prec_nig_NA, field = "X1")
mth_02_es_r <- rasterize(nig_all_sf_mth_es, r_prec_nig_NA, field = "X2")
mth_03_es_r <- rasterize(nig_all_sf_mth_es, r_prec_nig_NA, field = "X3")
mth_04_es_r <- rasterize(nig_all_sf_mth_es, r_prec_nig_NA, field = "X4")
mth_05_es_r <- rasterize(nig_all_sf_mth_es, r_prec_nig_NA, field = "X5")
mth_06_es_r <- rasterize(nig_all_sf_mth_es, r_prec_nig_NA, field = "X6")
mth_07_es_r <- rasterize(nig_all_sf_mth_es, r_prec_nig_NA, field = "X7")
mth_08_es_r <- rasterize(nig_all_sf_mth_es, r_prec_nig_NA, field = "X8")
mth_09_es_r <- rasterize(nig_all_sf_mth_es, r_prec_nig_NA, field = "X9")
mth_10_es_r <- rasterize(nig_all_sf_mth_es, r_prec_nig_NA, field = "X10")
mth_11_es_r <- rasterize(nig_all_sf_mth_es, r_prec_nig_NA, field = "X11")
mth_12_es_r <- rasterize(nig_all_sf_mth_es, r_prec_nig_NA, field = "X12")

mth_es_r <-
  rast(
    list(
      mth_01_es_r,
      mth_02_es_r,
      mth_03_es_r,
      mth_04_es_r,
      mth_05_es_r,
      mth_06_es_r,
      mth_07_es_r,
      mth_08_es_r,
      mth_09_es_r,
      mth_10_es_r,
      mth_11_es_r,
      mth_12_es_r
    )
  )

plot(mth_es_r, main = "establishment stage", maxnl = 12)

writeRaster(mth_es_r, 
    "D:/repos/sourcing_targets/data/NGA/sorghum/mth_es_r.tif",
    overwrite = TRUE,
    filetype = "GTiff"
  )

```

## Establishment stage - dekadal distribution

```{r phen_stages_est_dek_Nigeria, cache = FALSE, fig.width=8, fig.height=7, out.width=700}

#get a matrix of values showing the proportion of each month in the establishment stage for each cell

grow_e_matrix_m <- t(apply(nig_all_df, 1, easyfun, start_day = "hist_sorghum___onset", end_day = "est_e" ))

grow_e_matrix_d <- t(apply(nig_all_df, 1, growth_period_long_dekad_tbl, day_begin = "hist_sorghum___onset", day_end = "est_e", num_years = num_years))


#join the matrix to the existing data frame
nig_all_df_dek_es <- data.frame(nig_all_df, grow_e_matrix_d)

#convert first to sf object
nig_all_sf_dek_dek_es <-
  st_as_sf(nig_all_df_dek_es,
           coords = c("x.x", "y.x"),
           crs = 4236)

#create dekadal raster masks for the establishment stage
dek_01_es_r <- rasterize(nig_all_sf_dek_dek_es, r_prec_nig_NA, field = "X1")
dek_02_es_r <- rasterize(nig_all_sf_dek_dek_es, r_prec_nig_NA, field = "X2")
dek_03_es_r <- rasterize(nig_all_sf_dek_dek_es, r_prec_nig_NA, field = "X3")
dek_04_es_r <- rasterize(nig_all_sf_dek_dek_es, r_prec_nig_NA, field = "X4")
dek_05_es_r <- rasterize(nig_all_sf_dek_dek_es, r_prec_nig_NA, field = "X5")
dek_06_es_r <- rasterize(nig_all_sf_dek_dek_es, r_prec_nig_NA, field = "X6")
dek_07_es_r <- rasterize(nig_all_sf_dek_dek_es, r_prec_nig_NA, field = "X7")
dek_08_es_r <- rasterize(nig_all_sf_dek_dek_es, r_prec_nig_NA, field = "X8")
dek_09_es_r <- rasterize(nig_all_sf_dek_dek_es, r_prec_nig_NA, field = "X9")
dek_10_es_r <- rasterize(nig_all_sf_dek_dek_es, r_prec_nig_NA, field = "X10")
dek_11_es_r <- rasterize(nig_all_sf_dek_dek_es, r_prec_nig_NA, field = "X11")
dek_12_es_r <- rasterize(nig_all_sf_dek_dek_es, r_prec_nig_NA, field = "X12")
dek_13_es_r <- rasterize(nig_all_sf_dek_dek_es, r_prec_nig_NA, field = "X13")
dek_14_es_r <- rasterize(nig_all_sf_dek_dek_es, r_prec_nig_NA, field = "X14")
dek_15_es_r <- rasterize(nig_all_sf_dek_dek_es, r_prec_nig_NA, field = "X15")
dek_16_es_r <- rasterize(nig_all_sf_dek_dek_es, r_prec_nig_NA, field = "X16")
dek_17_es_r <- rasterize(nig_all_sf_dek_dek_es, r_prec_nig_NA, field = "X17")
dek_18_es_r <- rasterize(nig_all_sf_dek_dek_es, r_prec_nig_NA, field = "X18")
dek_19_es_r <- rasterize(nig_all_sf_dek_dek_es, r_prec_nig_NA, field = "X19")
dek_20_es_r <- rasterize(nig_all_sf_dek_dek_es, r_prec_nig_NA, field = "X20")
dek_21_es_r <- rasterize(nig_all_sf_dek_dek_es, r_prec_nig_NA, field = "X21")
dek_22_es_r <- rasterize(nig_all_sf_dek_dek_es, r_prec_nig_NA, field = "X22")
dek_23_es_r <- rasterize(nig_all_sf_dek_dek_es, r_prec_nig_NA, field = "X23")
dek_24_es_r <- rasterize(nig_all_sf_dek_dek_es, r_prec_nig_NA, field = "X24")
dek_25_es_r <- rasterize(nig_all_sf_dek_dek_es, r_prec_nig_NA, field = "X25")
dek_26_es_r <- rasterize(nig_all_sf_dek_dek_es, r_prec_nig_NA, field = "X26")
dek_27_es_r <- rasterize(nig_all_sf_dek_dek_es, r_prec_nig_NA, field = "X27")
dek_28_es_r <- rasterize(nig_all_sf_dek_dek_es, r_prec_nig_NA, field = "X28")
dek_29_es_r <- rasterize(nig_all_sf_dek_dek_es, r_prec_nig_NA, field = "X29")
dek_30_es_r <- rasterize(nig_all_sf_dek_dek_es, r_prec_nig_NA, field = "X30")
dek_31_es_r <- rasterize(nig_all_sf_dek_dek_es, r_prec_nig_NA, field = "X31")
dek_32_es_r <- rasterize(nig_all_sf_dek_dek_es, r_prec_nig_NA, field = "X32")
dek_33_es_r <- rasterize(nig_all_sf_dek_dek_es, r_prec_nig_NA, field = "X33")
dek_34_es_r <- rasterize(nig_all_sf_dek_dek_es, r_prec_nig_NA, field = "X34")
dek_35_es_r <- rasterize(nig_all_sf_dek_dek_es, r_prec_nig_NA, field = "X35")
dek_36_es_r <- rasterize(nig_all_sf_dek_dek_es, r_prec_nig_NA, field = "X36")


dek_es_r <-
  rast(
    list(
      dek_01_es_r,
      dek_02_es_r,
      dek_03_es_r,
      dek_04_es_r,
      dek_05_es_r,
      dek_06_es_r,
      dek_07_es_r,
      dek_08_es_r,
      dek_09_es_r,
      dek_10_es_r,
      dek_11_es_r,
      dek_12_es_r,
      dek_13_es_r,
      dek_14_es_r,
      dek_15_es_r,
      dek_16_es_r,
      dek_17_es_r,
      dek_18_es_r,
      dek_19_es_r,
      dek_20_es_r,
      dek_21_es_r,
      dek_22_es_r,
      dek_23_es_r,
      dek_24_es_r,
      dek_25_es_r,
      dek_26_es_r,
      dek_27_es_r,
      dek_28_es_r,
      dek_29_es_r,
      dek_30_es_r,
      dek_31_es_r,
      dek_32_es_r,
      dek_33_es_r,
      dek_34_es_r,
      dek_35_es_r,
      dek_36_es_r
    )
  )

plot(dek_es_r, main = "establishment stage", maxnl = 36)

writeRaster(dek_es_r, 
    "D:/repos/sourcing_targets/data/NGA/sorghum/dek_es_r.tif",
    overwrite = TRUE,
    filetype = "GTiff"
  )

```

## Vegetative stage - monthly  distribution

```{r phen_stages_veg_mth_Nigeria, cache = FALSE, fig.width=8, fig.height=7, out.width=700}

#get a matrix of values showing the proportion of each month in the Vegetative stage for each cell
grow_v_matrix_m <- t(apply(nig_all_df, 1, growth_period_long_tbl, day_begin = "veg_s", day_end = "veg_e", num_years = num_years ))

#join the matrix to the existing data frame
nig_all_df_mth_vs <- data.frame(nig_all_df, grow_v_matrix_m)

#convert first to sf object
nig_all_sf_mth_vs <-
  st_as_sf(nig_all_df_mth_vs,
           coords = c("x.x", "y.x"),
           crs = 4236)

#create monthly raster masks for the Vegetative stage
mth_01_vs_r <- rasterize(nig_all_sf_mth_vs, r_prec_nig_NA, field = "X1")
mth_02_vs_r <- rasterize(nig_all_sf_mth_vs, r_prec_nig_NA, field = "X2")
mth_03_vs_r <- rasterize(nig_all_sf_mth_vs, r_prec_nig_NA, field = "X3")
mth_04_vs_r <- rasterize(nig_all_sf_mth_vs, r_prec_nig_NA, field = "X4")
mth_05_vs_r <- rasterize(nig_all_sf_mth_vs, r_prec_nig_NA, field = "X5")
mth_06_vs_r <- rasterize(nig_all_sf_mth_vs, r_prec_nig_NA, field = "X6")
mth_07_vs_r <- rasterize(nig_all_sf_mth_vs, r_prec_nig_NA, field = "X7")
mth_08_vs_r <- rasterize(nig_all_sf_mth_vs, r_prec_nig_NA, field = "X8")
mth_09_vs_r <- rasterize(nig_all_sf_mth_vs, r_prec_nig_NA, field = "X9")
mth_10_vs_r <- rasterize(nig_all_sf_mth_vs, r_prec_nig_NA, field = "X10")
mth_11_vs_r <- rasterize(nig_all_sf_mth_vs, r_prec_nig_NA, field = "X11")
mth_12_vs_r <- rasterize(nig_all_sf_mth_vs, r_prec_nig_NA, field = "X12")

mth_vs_r <-
  rast(
    list(
      mth_01_vs_r,
      mth_02_vs_r,
      mth_03_vs_r,
      mth_04_vs_r,
      mth_05_vs_r,
      mth_06_vs_r,
      mth_07_vs_r,
      mth_08_vs_r,
      mth_09_vs_r,
      mth_10_vs_r,
      mth_11_vs_r,
      mth_12_vs_r
    )
  )

plot(mth_vs_r, main = "Vegetative stage", maxnl = 12)

writeRaster(mth_vs_r, 
    "D:/repos/sourcing_targets/data/NGA/sorghum/mth_vs_r.tif",
    overwrite = TRUE,
    filetype = "GTiff"
  )

```

## Vegetative stage - dekadal distribution

```{r phen_stages_veg_dek_Nigeria, cache = FALSE, fig.width=8, fig.height=7, out.width=700}

#get a matrix of values showing the proportion of each month in the vegetative stage for each cell

grow_v_matrix_m <- t(apply(nig_all_df, 1, easyfun, start_day = "veg_e", end_day = "veg_s" ))

grow_v_matrix_d <- t(apply(nig_all_df, 1, growth_period_long_dekad_tbl, day_begin = "veg_s", day_end = "veg_e", num_years = num_years))


# dekadal distribution

#join the matrix to the existing data frame
nig_all_df_dek_vs <- data.frame(nig_all_df, grow_v_matrix_d)

#convert first to sf object
nig_all_sf_dek_vs <-
  st_as_sf(nig_all_df_dek_vs,
           coords = c("x.x", "y.x"),
           crs = 4236)

#create dekadal raster masks for the vegetative stage
dek_01_vs_r <- rasterize(nig_all_sf_dek_vs, r_prec_nig_NA, field = "X1")
dek_02_vs_r <- rasterize(nig_all_sf_dek_vs, r_prec_nig_NA, field = "X2")
dek_03_vs_r <- rasterize(nig_all_sf_dek_vs, r_prec_nig_NA, field = "X3")
dek_04_vs_r <- rasterize(nig_all_sf_dek_vs, r_prec_nig_NA, field = "X4")
dek_05_vs_r <- rasterize(nig_all_sf_dek_vs, r_prec_nig_NA, field = "X5")
dek_06_vs_r <- rasterize(nig_all_sf_dek_vs, r_prec_nig_NA, field = "X6")
dek_07_vs_r <- rasterize(nig_all_sf_dek_vs, r_prec_nig_NA, field = "X7")
dek_08_vs_r <- rasterize(nig_all_sf_dek_vs, r_prec_nig_NA, field = "X8")
dek_09_vs_r <- rasterize(nig_all_sf_dek_vs, r_prec_nig_NA, field = "X9")
dek_10_vs_r <- rasterize(nig_all_sf_dek_vs, r_prec_nig_NA, field = "X10")
dek_11_vs_r <- rasterize(nig_all_sf_dek_vs, r_prec_nig_NA, field = "X11")
dek_12_vs_r <- rasterize(nig_all_sf_dek_vs, r_prec_nig_NA, field = "X12")
dek_13_vs_r <- rasterize(nig_all_sf_dek_vs, r_prec_nig_NA, field = "X13")
dek_14_vs_r <- rasterize(nig_all_sf_dek_vs, r_prec_nig_NA, field = "X14")
dek_15_vs_r <- rasterize(nig_all_sf_dek_vs, r_prec_nig_NA, field = "X15")
dek_16_vs_r <- rasterize(nig_all_sf_dek_vs, r_prec_nig_NA, field = "X16")
dek_17_vs_r <- rasterize(nig_all_sf_dek_vs, r_prec_nig_NA, field = "X17")
dek_18_vs_r <- rasterize(nig_all_sf_dek_vs, r_prec_nig_NA, field = "X18")
dek_19_vs_r <- rasterize(nig_all_sf_dek_vs, r_prec_nig_NA, field = "X19")
dek_20_vs_r <- rasterize(nig_all_sf_dek_vs, r_prec_nig_NA, field = "X20")
dek_21_vs_r <- rasterize(nig_all_sf_dek_vs, r_prec_nig_NA, field = "X21")
dek_22_vs_r <- rasterize(nig_all_sf_dek_vs, r_prec_nig_NA, field = "X22")
dek_23_vs_r <- rasterize(nig_all_sf_dek_vs, r_prec_nig_NA, field = "X23")
dek_24_vs_r <- rasterize(nig_all_sf_dek_vs, r_prec_nig_NA, field = "X24")
dek_25_vs_r <- rasterize(nig_all_sf_dek_vs, r_prec_nig_NA, field = "X25")
dek_26_vs_r <- rasterize(nig_all_sf_dek_vs, r_prec_nig_NA, field = "X26")
dek_27_vs_r <- rasterize(nig_all_sf_dek_vs, r_prec_nig_NA, field = "X27")
dek_28_vs_r <- rasterize(nig_all_sf_dek_vs, r_prec_nig_NA, field = "X28")
dek_29_vs_r <- rasterize(nig_all_sf_dek_vs, r_prec_nig_NA, field = "X29")
dek_30_vs_r <- rasterize(nig_all_sf_dek_vs, r_prec_nig_NA, field = "X30")
dek_31_vs_r <- rasterize(nig_all_sf_dek_vs, r_prec_nig_NA, field = "X31")
dek_32_vs_r <- rasterize(nig_all_sf_dek_vs, r_prec_nig_NA, field = "X32")
dek_33_vs_r <- rasterize(nig_all_sf_dek_vs, r_prec_nig_NA, field = "X33")
dek_34_vs_r <- rasterize(nig_all_sf_dek_vs, r_prec_nig_NA, field = "X34")
dek_35_vs_r <- rasterize(nig_all_sf_dek_vs, r_prec_nig_NA, field = "X35")
dek_36_vs_r <- rasterize(nig_all_sf_dek_vs, r_prec_nig_NA, field = "X36")


dek_vs_r <-
  rast(
    list(
      dek_01_vs_r,
      dek_02_vs_r,
      dek_03_vs_r,
      dek_04_vs_r,
      dek_05_vs_r,
      dek_06_vs_r,
      dek_07_vs_r,
      dek_08_vs_r,
      dek_09_vs_r,
      dek_10_vs_r,
      dek_11_vs_r,
      dek_12_vs_r,
      dek_13_vs_r,
      dek_14_vs_r,
      dek_15_vs_r,
      dek_16_vs_r,
      dek_17_vs_r,
      dek_18_vs_r,
      dek_19_vs_r,
      dek_20_vs_r,
      dek_21_vs_r,
      dek_22_vs_r,
      dek_23_vs_r,
      dek_24_vs_r,
      dek_25_vs_r,
      dek_26_vs_r,
      dek_27_vs_r,
      dek_28_vs_r,
      dek_29_vs_r,
      dek_30_vs_r,
      dek_31_vs_r,
      dek_32_vs_r,
      dek_33_vs_r,
      dek_34_vs_r,
      dek_35_vs_r,
      dek_36_vs_r
    )
  )

plot(dek_vs_r, main = "vegetative stage", maxnl = 36)

writeRaster(dek_vs_r, 
    "D:/repos/sourcing_targets/data/NGA/sorghum/dek_vs_r.tif",
    overwrite = TRUE,
    filetype = "GTiff"
  )

```


## Flowering stage - monthly  distribution

```{r phen_stages_flw_mth_Nigeria, cache = FALSE, fig.width=8, fig.height=7, out.width=700}

#get a matrix of values showing the proportion of each month in the flowering stage for each cell
grow_f_matrix_m <- t(apply(nig_all_df, 1, growth_period_long_tbl, day_begin = "flw_s", day_end = "flw_e", num_years = num_years ))

#join the matrix to the existing data frame
nig_all_df_mth_fs <- data.frame(nig_all_df, grow_f_matrix_m)

#convert first to sf object
nig_all_sf_mth_fs <-
  st_as_sf(nig_all_df_mth_fs,
           coords = c("x.x", "y.x"),
           crs = 4236)

#create monthly raster masks for the flowering stage
mth_01_fs_r <- rasterize(nig_all_sf_mth_fs, r_prec_nig_NA, field = "X1")
mth_02_fs_r <- rasterize(nig_all_sf_mth_fs, r_prec_nig_NA, field = "X2")
mth_03_fs_r <- rasterize(nig_all_sf_mth_fs, r_prec_nig_NA, field = "X3")
mth_04_fs_r <- rasterize(nig_all_sf_mth_fs, r_prec_nig_NA, field = "X4")
mth_05_fs_r <- rasterize(nig_all_sf_mth_fs, r_prec_nig_NA, field = "X5")
mth_06_fs_r <- rasterize(nig_all_sf_mth_fs, r_prec_nig_NA, field = "X6")
mth_07_fs_r <- rasterize(nig_all_sf_mth_fs, r_prec_nig_NA, field = "X7")
mth_08_fs_r <- rasterize(nig_all_sf_mth_fs, r_prec_nig_NA, field = "X8")
mth_09_fs_r <- rasterize(nig_all_sf_mth_fs, r_prec_nig_NA, field = "X9")
mth_10_fs_r <- rasterize(nig_all_sf_mth_fs, r_prec_nig_NA, field = "X10")
mth_11_fs_r <- rasterize(nig_all_sf_mth_fs, r_prec_nig_NA, field = "X11")
mth_12_fs_r <- rasterize(nig_all_sf_mth_fs, r_prec_nig_NA, field = "X12")

mth_fs_r <-
  rast(
    list(
      mth_01_fs_r,
      mth_02_fs_r,
      mth_03_fs_r,
      mth_04_fs_r,
      mth_05_fs_r,
      mth_06_fs_r,
      mth_07_fs_r,
      mth_08_fs_r,
      mth_09_fs_r,
      mth_10_fs_r,
      mth_11_fs_r,
      mth_12_fs_r
    )
  )

plot(mth_fs_r, main = "Flowering stage", maxnl = 12)

writeRaster(mth_fs_r, 
    "D:/repos/sourcing_targets/data/NGA/sorghum/mth_fs_r.tif",
    overwrite = TRUE,
    filetype = "GTiff"
  )
```

## Flowering stage - dekadal distribution

```{r phen_stages_flw_dek_Nigeria, cache = FALSE, fig.width=8, fig.height=7, out.width=700}

#get a matrix of values showing the proportion of each month in the flowering stage for each cell

grow_f_matrix_m <- t(apply(nig_all_df, 1, easyfun, start_day = "flw_e", end_day = "flw_s" ))

grow_f_matrix_d <- t(apply(nig_all_df, 1, growth_period_long_dekad_tbl, day_begin = "flw_s", day_end = "flw_e", num_years = num_years))


#join the matrix to the existing data frame
nig_all_df_dek_fs <- data.frame(nig_all_df, grow_f_matrix_d)

#convert first to sf object
nig_all_sf_dek_fs <-
  st_as_sf(nig_all_df_dek_fs,
           coords = c("x.x", "y.x"),
           crs = 4236)

#create dekadal raster masks for the flowering stage
dek_01_fs_r <- rasterize(nig_all_sf_dek_fs, r_prec_nig_NA, field = "X1")
dek_02_fs_r <- rasterize(nig_all_sf_dek_fs, r_prec_nig_NA, field = "X2")
dek_03_fs_r <- rasterize(nig_all_sf_dek_fs, r_prec_nig_NA, field = "X3")
dek_04_fs_r <- rasterize(nig_all_sf_dek_fs, r_prec_nig_NA, field = "X4")
dek_05_fs_r <- rasterize(nig_all_sf_dek_fs, r_prec_nig_NA, field = "X5")
dek_06_fs_r <- rasterize(nig_all_sf_dek_fs, r_prec_nig_NA, field = "X6")
dek_07_fs_r <- rasterize(nig_all_sf_dek_fs, r_prec_nig_NA, field = "X7")
dek_08_fs_r <- rasterize(nig_all_sf_dek_fs, r_prec_nig_NA, field = "X8")
dek_09_fs_r <- rasterize(nig_all_sf_dek_fs, r_prec_nig_NA, field = "X9")
dek_10_fs_r <- rasterize(nig_all_sf_dek_fs, r_prec_nig_NA, field = "X10")
dek_11_fs_r <- rasterize(nig_all_sf_dek_fs, r_prec_nig_NA, field = "X11")
dek_12_fs_r <- rasterize(nig_all_sf_dek_fs, r_prec_nig_NA, field = "X12")
dek_13_fs_r <- rasterize(nig_all_sf_dek_fs, r_prec_nig_NA, field = "X13")
dek_14_fs_r <- rasterize(nig_all_sf_dek_fs, r_prec_nig_NA, field = "X14")
dek_15_fs_r <- rasterize(nig_all_sf_dek_fs, r_prec_nig_NA, field = "X15")
dek_16_fs_r <- rasterize(nig_all_sf_dek_fs, r_prec_nig_NA, field = "X16")
dek_17_fs_r <- rasterize(nig_all_sf_dek_fs, r_prec_nig_NA, field = "X17")
dek_18_fs_r <- rasterize(nig_all_sf_dek_fs, r_prec_nig_NA, field = "X18")
dek_19_fs_r <- rasterize(nig_all_sf_dek_fs, r_prec_nig_NA, field = "X19")
dek_20_fs_r <- rasterize(nig_all_sf_dek_fs, r_prec_nig_NA, field = "X20")
dek_21_fs_r <- rasterize(nig_all_sf_dek_fs, r_prec_nig_NA, field = "X21")
dek_22_fs_r <- rasterize(nig_all_sf_dek_fs, r_prec_nig_NA, field = "X22")
dek_23_fs_r <- rasterize(nig_all_sf_dek_fs, r_prec_nig_NA, field = "X23")
dek_24_fs_r <- rasterize(nig_all_sf_dek_fs, r_prec_nig_NA, field = "X24")
dek_25_fs_r <- rasterize(nig_all_sf_dek_fs, r_prec_nig_NA, field = "X25")
dek_26_fs_r <- rasterize(nig_all_sf_dek_fs, r_prec_nig_NA, field = "X26")
dek_27_fs_r <- rasterize(nig_all_sf_dek_fs, r_prec_nig_NA, field = "X27")
dek_28_fs_r <- rasterize(nig_all_sf_dek_fs, r_prec_nig_NA, field = "X28")
dek_29_fs_r <- rasterize(nig_all_sf_dek_fs, r_prec_nig_NA, field = "X29")
dek_30_fs_r <- rasterize(nig_all_sf_dek_fs, r_prec_nig_NA, field = "X30")
dek_31_fs_r <- rasterize(nig_all_sf_dek_fs, r_prec_nig_NA, field = "X31")
dek_32_fs_r <- rasterize(nig_all_sf_dek_fs, r_prec_nig_NA, field = "X32")
dek_33_fs_r <- rasterize(nig_all_sf_dek_fs, r_prec_nig_NA, field = "X33")
dek_34_fs_r <- rasterize(nig_all_sf_dek_fs, r_prec_nig_NA, field = "X34")
dek_35_fs_r <- rasterize(nig_all_sf_dek_fs, r_prec_nig_NA, field = "X35")
dek_36_fs_r <- rasterize(nig_all_sf_dek_fs, r_prec_nig_NA, field = "X36")


dek_fs_r <-
  rast(
    list(
      dek_01_fs_r,
      dek_02_fs_r,
      dek_03_fs_r,
      dek_04_fs_r,
      dek_05_fs_r,
      dek_06_fs_r,
      dek_07_fs_r,
      dek_08_fs_r,
      dek_09_fs_r,
      dek_10_fs_r,
      dek_11_fs_r,
      dek_12_fs_r,
      dek_13_fs_r,
      dek_14_fs_r,
      dek_15_fs_r,
      dek_16_fs_r,
      dek_17_fs_r,
      dek_18_fs_r,
      dek_19_fs_r,
      dek_20_fs_r,
      dek_21_fs_r,
      dek_22_fs_r,
      dek_23_fs_r,
      dek_24_fs_r,
      dek_25_fs_r,
      dek_26_fs_r,
      dek_27_fs_r,
      dek_28_fs_r,
      dek_29_fs_r,
      dek_30_fs_r,
      dek_31_fs_r,
      dek_32_fs_r,
      dek_33_fs_r,
      dek_34_fs_r,
      dek_35_fs_r,
      dek_36_fs_r
    )
  )

plot(dek_fs_r, main = "flowering stage", maxnl = 36)

writeRaster(dek_fs_r, 
    "D:/repos/sourcing_targets/data/NGA/sorghum/dek_fs_r.tif",
    overwrite = TRUE,
    filetype = "GTiff"
  )
```


## Yield Formation stage - monthly  distribution

```{r phen_stages_yld_mth_Nigeria, cache = FALSE, fig.width=8, fig.height=7, out.width=700}

#get a matrix of values showing the proportion of each month in the yield formation stage for each cell
grow_y_matrix_m <- t(apply(nig_all_df, 1, growth_period_long_tbl, day_begin = "yld_s", day_end = "yld_e", num_years = num_years ))

#join the matrix to the existing data frame
nig_all_df_mth_ys <- data.frame(nig_all_df, grow_y_matrix_m)

#convert first to sf object
nig_all_sf_mth_ys <-
  st_as_sf(nig_all_df_mth_fs,
           coords = c("x.x", "y.x"),
           crs = 4236)

#create monthly raster masks for the yield formation stage
mth_01_ys_r <- rasterize(nig_all_sf_mth_ys, r_prec_nig_NA, field = "X1")
mth_02_ys_r <- rasterize(nig_all_sf_mth_ys, r_prec_nig_NA, field = "X2")
mth_03_ys_r <- rasterize(nig_all_sf_mth_ys, r_prec_nig_NA, field = "X3")
mth_04_ys_r <- rasterize(nig_all_sf_mth_ys, r_prec_nig_NA, field = "X4")
mth_05_ys_r <- rasterize(nig_all_sf_mth_ys, r_prec_nig_NA, field = "X5")
mth_06_ys_r <- rasterize(nig_all_sf_mth_ys, r_prec_nig_NA, field = "X6")
mth_07_ys_r <- rasterize(nig_all_sf_mth_ys, r_prec_nig_NA, field = "X7")
mth_08_ys_r <- rasterize(nig_all_sf_mth_ys, r_prec_nig_NA, field = "X8")
mth_09_ys_r <- rasterize(nig_all_sf_mth_ys, r_prec_nig_NA, field = "X9")
mth_10_ys_r <- rasterize(nig_all_sf_mth_ys, r_prec_nig_NA, field = "X10")
mth_11_ys_r <- rasterize(nig_all_sf_mth_ys, r_prec_nig_NA, field = "X11")
mth_12_ys_r <- rasterize(nig_all_sf_mth_ys, r_prec_nig_NA, field = "X12")

mth_ys_r <-
  rast(
    list(
      mth_01_ys_r,
      mth_02_ys_r,
      mth_03_ys_r,
      mth_04_ys_r,
      mth_05_ys_r,
      mth_06_ys_r,
      mth_07_ys_r,
      mth_08_ys_r,
      mth_09_ys_r,
      mth_10_ys_r,
      mth_11_ys_r,
      mth_12_ys_r
    )
  )

plot(mth_ys_r, main = "yield formation stage", maxnl = 12)

writeRaster(mth_ys_r, 
    "D:/repos/sourcing_targets/data/NGA/sorghum/mth_ys_r.tif",
    overwrite = TRUE,
    filetype = "GTiff"
  )
```

## Yield Formation stage - dekadal distribution

```{r phen_stages_yld_dek_Nigeria, cache = FALSE, fig.width=8, fig.height=7, out.width=700}

#get a matrix of values showing the proportion of each month in the yield formation stage for each cell

grow_y_matrix_m <- t(apply(nig_all_df, 1, easyfun, start_day = "yld_e", end_day = "yld_s" ))

grow_y_matrix_d <- t(apply(nig_all_df, 1, growth_period_long_dekad_tbl, day_begin = "yld_s", day_end = "yld_e", num_years = num_years))


#join the matrix to the existing data frame
nig_all_df_dek_ys <- data.frame(nig_all_df, grow_y_matrix_d)

#convert first to sf object
nig_all_sf_dek_ys <-
  st_as_sf(nig_all_df_dek_ys,
           coords = c("x.x", "y.x"),
           crs = 4236)

#create dekadal raster masks for the yield formation stage
dek_01_ys_r <- rasterize(nig_all_sf_dek_ys, r_prec_nig_NA, field = "X1")
dek_02_ys_r <- rasterize(nig_all_sf_dek_ys, r_prec_nig_NA, field = "X2")
dek_03_ys_r <- rasterize(nig_all_sf_dek_ys, r_prec_nig_NA, field = "X3")
dek_04_ys_r <- rasterize(nig_all_sf_dek_ys, r_prec_nig_NA, field = "X4")
dek_05_ys_r <- rasterize(nig_all_sf_dek_ys, r_prec_nig_NA, field = "X5")
dek_06_ys_r <- rasterize(nig_all_sf_dek_ys, r_prec_nig_NA, field = "X6")
dek_07_ys_r <- rasterize(nig_all_sf_dek_ys, r_prec_nig_NA, field = "X7")
dek_08_ys_r <- rasterize(nig_all_sf_dek_ys, r_prec_nig_NA, field = "X8")
dek_09_ys_r <- rasterize(nig_all_sf_dek_ys, r_prec_nig_NA, field = "X9")
dek_10_ys_r <- rasterize(nig_all_sf_dek_ys, r_prec_nig_NA, field = "X10")
dek_11_ys_r <- rasterize(nig_all_sf_dek_ys, r_prec_nig_NA, field = "X11")
dek_12_ys_r <- rasterize(nig_all_sf_dek_ys, r_prec_nig_NA, field = "X12")
dek_13_ys_r <- rasterize(nig_all_sf_dek_ys, r_prec_nig_NA, field = "X13")
dek_14_ys_r <- rasterize(nig_all_sf_dek_ys, r_prec_nig_NA, field = "X14")
dek_15_ys_r <- rasterize(nig_all_sf_dek_ys, r_prec_nig_NA, field = "X15")
dek_16_ys_r <- rasterize(nig_all_sf_dek_ys, r_prec_nig_NA, field = "X16")
dek_17_ys_r <- rasterize(nig_all_sf_dek_ys, r_prec_nig_NA, field = "X17")
dek_18_ys_r <- rasterize(nig_all_sf_dek_ys, r_prec_nig_NA, field = "X18")
dek_19_ys_r <- rasterize(nig_all_sf_dek_ys, r_prec_nig_NA, field = "X19")
dek_20_ys_r <- rasterize(nig_all_sf_dek_ys, r_prec_nig_NA, field = "X20")
dek_21_ys_r <- rasterize(nig_all_sf_dek_ys, r_prec_nig_NA, field = "X21")
dek_22_ys_r <- rasterize(nig_all_sf_dek_ys, r_prec_nig_NA, field = "X22")
dek_23_ys_r <- rasterize(nig_all_sf_dek_ys, r_prec_nig_NA, field = "X23")
dek_24_ys_r <- rasterize(nig_all_sf_dek_ys, r_prec_nig_NA, field = "X24")
dek_25_ys_r <- rasterize(nig_all_sf_dek_ys, r_prec_nig_NA, field = "X25")
dek_26_ys_r <- rasterize(nig_all_sf_dek_ys, r_prec_nig_NA, field = "X26")
dek_27_ys_r <- rasterize(nig_all_sf_dek_ys, r_prec_nig_NA, field = "X27")
dek_28_ys_r <- rasterize(nig_all_sf_dek_ys, r_prec_nig_NA, field = "X28")
dek_29_ys_r <- rasterize(nig_all_sf_dek_ys, r_prec_nig_NA, field = "X29")
dek_30_ys_r <- rasterize(nig_all_sf_dek_ys, r_prec_nig_NA, field = "X30")
dek_31_ys_r <- rasterize(nig_all_sf_dek_ys, r_prec_nig_NA, field = "X31")
dek_32_ys_r <- rasterize(nig_all_sf_dek_ys, r_prec_nig_NA, field = "X32")
dek_33_ys_r <- rasterize(nig_all_sf_dek_ys, r_prec_nig_NA, field = "X33")
dek_34_ys_r <- rasterize(nig_all_sf_dek_ys, r_prec_nig_NA, field = "X34")
dek_35_ys_r <- rasterize(nig_all_sf_dek_ys, r_prec_nig_NA, field = "X35")
dek_36_ys_r <- rasterize(nig_all_sf_dek_ys, r_prec_nig_NA, field = "X36")


dek_ys_r <-
  rast(
    list(
      dek_01_ys_r,
      dek_02_ys_r,
      dek_03_ys_r,
      dek_04_ys_r,
      dek_05_ys_r,
      dek_06_ys_r,
      dek_07_ys_r,
      dek_08_ys_r,
      dek_09_ys_r,
      dek_10_ys_r,
      dek_11_ys_r,
      dek_12_ys_r,
      dek_13_ys_r,
      dek_14_ys_r,
      dek_15_ys_r,
      dek_16_ys_r,
      dek_17_ys_r,
      dek_18_ys_r,
      dek_19_ys_r,
      dek_20_ys_r,
      dek_21_ys_r,
      dek_22_ys_r,
      dek_23_ys_r,
      dek_24_ys_r,
      dek_25_ys_r,
      dek_26_ys_r,
      dek_27_ys_r,
      dek_28_ys_r,
      dek_29_ys_r,
      dek_30_ys_r,
      dek_31_ys_r,
      dek_32_ys_r,
      dek_33_ys_r,
      dek_34_ys_r,
      dek_35_ys_r,
      dek_36_ys_r
    )
  )

plot(dek_ys_r, main = "yield formation stage", maxnl = 36)

writeRaster(dek_ys_r, 
    "D:/repos/sourcing_targets/data/NGA/sorghum/dek_ys_r.tif",
    overwrite = TRUE,
    filetype = "GTiff"
  )
```

## Ripening stage - monthly  distribution

```{r phen_stages_rip_mth_Nigeria, cache = FALSE, fig.width=8, fig.height=7, out.width=700}

#get a matrix of values showing the proportion of each month in the Ripening stage for each cell
grow_r_matrix_m <- t(apply(nig_all_df, 1, growth_period_long_tbl, day_begin = "rip_s", day_end = "rip_e", num_years = num_years ))

#join the matrix to the existing data frame
nig_all_df_mth_rs <- data.frame(nig_all_df, grow_r_matrix_m)

#convert first to sf object
nig_all_sf_mth_rs <-
  st_as_sf(nig_all_df_mth_rs,
           coords = c("x.x", "y.x"),
           crs = 4236)

#create monthly raster masks for the Ripening stage
mth_01_rs_r <- rasterize(nig_all_sf_mth_rs, r_prec_nig_NA, field = "X1")
mth_02_rs_r <- rasterize(nig_all_sf_mth_rs, r_prec_nig_NA, field = "X2")
mth_03_rs_r <- rasterize(nig_all_sf_mth_rs, r_prec_nig_NA, field = "X3")
mth_04_rs_r <- rasterize(nig_all_sf_mth_rs, r_prec_nig_NA, field = "X4")
mth_05_rs_r <- rasterize(nig_all_sf_mth_rs, r_prec_nig_NA, field = "X5")
mth_06_rs_r <- rasterize(nig_all_sf_mth_rs, r_prec_nig_NA, field = "X6")
mth_07_rs_r <- rasterize(nig_all_sf_mth_rs, r_prec_nig_NA, field = "X7")
mth_08_rs_r <- rasterize(nig_all_sf_mth_rs, r_prec_nig_NA, field = "X8")
mth_09_rs_r <- rasterize(nig_all_sf_mth_rs, r_prec_nig_NA, field = "X9")
mth_10_rs_r <- rasterize(nig_all_sf_mth_rs, r_prec_nig_NA, field = "X10")
mth_11_rs_r <- rasterize(nig_all_sf_mth_rs, r_prec_nig_NA, field = "X11")
mth_12_rs_r <- rasterize(nig_all_sf_mth_rs, r_prec_nig_NA, field = "X12")

mth_rs_r <-
  rast(
    list(
      mth_01_rs_r,
      mth_02_rs_r,
      mth_03_rs_r,
      mth_04_rs_r,
      mth_05_rs_r,
      mth_06_rs_r,
      mth_07_rs_r,
      mth_08_rs_r,
      mth_09_rs_r,
      mth_10_rs_r,
      mth_11_rs_r,
      mth_12_rs_r
    )
  )

plot(mth_rs_r, main = "Ripening stage", maxnl = 12)

writeRaster(mth_rs_r, 
    "D:/repos/sourcing_targets/data/NGA/sorghum/mth_rs_r.tif",
    overwrite = TRUE,
    filetype = "GTiff"
  )
```

## Ripening stage - dekadal distribution

```{r phen_stages_rip_dek_Nigeria, cache = FALSE, fig.width=8, fig.height=7, out.width=700}

#get a matrix of values showing the proportion of each month in the ripening stage for each cell

grow_r_matrix_m <- t(apply(nig_all_df, 1, easyfun, start_day = "rip_e", end_day = "rip_s" ))

grow_r_matrix_d <- t(apply(nig_all_df, 1, growth_period_long_dekad_tbl, day_begin = "rip_s", day_end = "rip_e", num_years = num_years))

# dekadal distribution
#join the matrix to the existing data frame
nig_all_df_dek_rs <- data.frame(nig_all_df, grow_r_matrix_d)

#convert first to sf object
nig_all_sf_dek_rs <-
  st_as_sf(nig_all_df_dek_rs,
           coords = c("x.x", "y.x"),
           crs = 4236)

#create dekadal raster masks for the ripening stage
dek_01_rs_r <- rasterize(nig_all_sf_dek_rs, r_prec_nig_NA, field = "X1")
dek_02_rs_r <- rasterize(nig_all_sf_dek_rs, r_prec_nig_NA, field = "X2")
dek_03_rs_r <- rasterize(nig_all_sf_dek_rs, r_prec_nig_NA, field = "X3")
dek_04_rs_r <- rasterize(nig_all_sf_dek_rs, r_prec_nig_NA, field = "X4")
dek_05_rs_r <- rasterize(nig_all_sf_dek_rs, r_prec_nig_NA, field = "X5")
dek_06_rs_r <- rasterize(nig_all_sf_dek_rs, r_prec_nig_NA, field = "X6")
dek_07_rs_r <- rasterize(nig_all_sf_dek_rs, r_prec_nig_NA, field = "X7")
dek_08_rs_r <- rasterize(nig_all_sf_dek_rs, r_prec_nig_NA, field = "X8")
dek_09_rs_r <- rasterize(nig_all_sf_dek_rs, r_prec_nig_NA, field = "X9")
dek_10_rs_r <- rasterize(nig_all_sf_dek_rs, r_prec_nig_NA, field = "X10")
dek_11_rs_r <- rasterize(nig_all_sf_dek_rs, r_prec_nig_NA, field = "X11")
dek_12_rs_r <- rasterize(nig_all_sf_dek_rs, r_prec_nig_NA, field = "X12")
dek_13_rs_r <- rasterize(nig_all_sf_dek_rs, r_prec_nig_NA, field = "X13")
dek_14_rs_r <- rasterize(nig_all_sf_dek_rs, r_prec_nig_NA, field = "X14")
dek_15_rs_r <- rasterize(nig_all_sf_dek_rs, r_prec_nig_NA, field = "X15")
dek_16_rs_r <- rasterize(nig_all_sf_dek_rs, r_prec_nig_NA, field = "X16")
dek_17_rs_r <- rasterize(nig_all_sf_dek_rs, r_prec_nig_NA, field = "X17")
dek_18_rs_r <- rasterize(nig_all_sf_dek_rs, r_prec_nig_NA, field = "X18")
dek_19_rs_r <- rasterize(nig_all_sf_dek_rs, r_prec_nig_NA, field = "X19")
dek_20_rs_r <- rasterize(nig_all_sf_dek_rs, r_prec_nig_NA, field = "X20")
dek_21_rs_r <- rasterize(nig_all_sf_dek_rs, r_prec_nig_NA, field = "X21")
dek_22_rs_r <- rasterize(nig_all_sf_dek_rs, r_prec_nig_NA, field = "X22")
dek_23_rs_r <- rasterize(nig_all_sf_dek_rs, r_prec_nig_NA, field = "X23")
dek_24_rs_r <- rasterize(nig_all_sf_dek_rs, r_prec_nig_NA, field = "X24")
dek_25_rs_r <- rasterize(nig_all_sf_dek_rs, r_prec_nig_NA, field = "X25")
dek_26_rs_r <- rasterize(nig_all_sf_dek_rs, r_prec_nig_NA, field = "X26")
dek_27_rs_r <- rasterize(nig_all_sf_dek_rs, r_prec_nig_NA, field = "X27")
dek_28_rs_r <- rasterize(nig_all_sf_dek_rs, r_prec_nig_NA, field = "X28")
dek_29_rs_r <- rasterize(nig_all_sf_dek_rs, r_prec_nig_NA, field = "X29")
dek_30_rs_r <- rasterize(nig_all_sf_dek_rs, r_prec_nig_NA, field = "X30")
dek_31_rs_r <- rasterize(nig_all_sf_dek_rs, r_prec_nig_NA, field = "X31")
dek_32_rs_r <- rasterize(nig_all_sf_dek_rs, r_prec_nig_NA, field = "X32")
dek_33_rs_r <- rasterize(nig_all_sf_dek_rs, r_prec_nig_NA, field = "X33")
dek_34_rs_r <- rasterize(nig_all_sf_dek_rs, r_prec_nig_NA, field = "X34")
dek_35_rs_r <- rasterize(nig_all_sf_dek_rs, r_prec_nig_NA, field = "X35")
dek_36_rs_r <- rasterize(nig_all_sf_dek_rs, r_prec_nig_NA, field = "X36")


dek_rs_r <-
  rast(
    list(
      dek_01_rs_r,
      dek_02_rs_r,
      dek_03_rs_r,
      dek_04_rs_r,
      dek_05_rs_r,
      dek_06_rs_r,
      dek_07_rs_r,
      dek_08_rs_r,
      dek_09_rs_r,
      dek_10_rs_r,
      dek_11_rs_r,
      dek_12_rs_r,
      dek_13_rs_r,
      dek_14_rs_r,
      dek_15_rs_r,
      dek_16_rs_r,
      dek_17_rs_r,
      dek_18_rs_r,
      dek_19_rs_r,
      dek_20_rs_r,
      dek_21_rs_r,
      dek_22_rs_r,
      dek_23_rs_r,
      dek_24_rs_r,
      dek_25_rs_r,
      dek_26_rs_r,
      dek_27_rs_r,
      dek_28_rs_r,
      dek_29_rs_r,
      dek_30_rs_r,
      dek_31_rs_r,
      dek_32_rs_r,
      dek_33_rs_r,
      dek_34_rs_r,
      dek_35_rs_r,
      dek_36_rs_r
    )
  )

plot(dek_rs_r, main = "ripening stage", maxnl = 36)

writeRaster(dek_gp_r, 
    "D:/repos/sourcing_targets/data/NGA/sorghum/dek_rs_r.tif",
    overwrite = TRUE,
    filetype = "GTiff"
  )
```
